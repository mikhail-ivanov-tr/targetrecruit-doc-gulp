

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: sfdx-source/shared/main/default/lwc/uploadFiles/uploadFiles.js | Shared Code Documentation</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
        
            <link type="text/css" rel="stylesheet" href="styles/custom.css">
        
    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="width: 80px; height: 13px">
        
            <a href="https://targetrecruit.com" rel="noopener noreferrer" target="_blank">
                <img src="https://targetrecruit.com/wp-content/uploads/2022/07/TargetRecruit_logo_purple.png" width="100%" height="100%">
            </a>
        
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">Shared Code Documentation</a></h1>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
        <ol class="lnb-tab">
            <li id="api-tab">
                <a href="#"><h4>API</h4></a>
            </li>
            <li id="examples-tab">
                <a href="#"><h4>Tutorials</h4></a>
            </li>
        </ol>
    
    <h2>Main</h2><div class="lnb-examples hidden"><h3>Tutorials</h3><ul><li><a href="tutorial-jest-tests.html">Jest Tests</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="jest-tests_sub"></div></li></ul></div><div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="CustomElement.html">CustomElement</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="CustomElement_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="CustomElement.html#handlerInProgress">handlerInProgress</a></li><li><a href="CustomElement.html#initialError">initialError</a></li><li><a href="CustomElement.html#initialErrorLabel">initialErrorLabel</a></li><li><a href="CustomElement.html#initialLoading">initialLoading</a></li><li><a href="CustomElement.html#label">label</a></li><li><a href="CustomElement.html#loading">loading</a></li><li><a href="CustomElement.html#loadingGlobal">loadingGlobal</a></li><li><a href="CustomElement.html#messages">messages</a></li><li><a href="CustomElement.html#messagesGlobal">messagesGlobal</a></li><li><a href="CustomElement.html#ready">ready</a></li><li><a href="CustomElement.html#staticData">staticData</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="CustomElement.html#addError">addError</a></li><li><a href="CustomElement.html#addInfo">addInfo</a></li><li><a href="CustomElement.html#addSuccess">addSuccess</a></li><li><a href="CustomElement.html#addWarning">addWarning</a></li><li><a href="CustomElement.html#apex">apex</a></li><li><a href="CustomElement.html#closeWindow">closeWindow</a></li><li><a href="CustomElement.html#connectedOnceCallback">connectedOnceCallback</a></li><li><a href="CustomElement.html#dispatchAsync">dispatchAsync</a></li><li><a href="CustomElement.html#renderedOnceCallback">renderedOnceCallback</a></li></ul></div></li><li><a href="Messages.html">Messages</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Messages_sub"></div></li><li><span class="icon green">LWC</span>&nbsp;<a href="UploadFiles.html">UploadFiles</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="UploadFiles_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="UploadFiles.html#audioFileSize">audioFileSize</a></li><li><a href="UploadFiles.html#baseFileSize">baseFileSize</a></li><li><a href="UploadFiles.html#contentType">contentType</a></li><li><a href="UploadFiles.html#documentFileSize">documentFileSize</a></li><li><a href="UploadFiles.html#fileTypes">fileTypes</a></li><li><a href="UploadFiles.html#helpText">helpText</a></li><li><a href="UploadFiles.html#imageFileSize">imageFileSize</a></li><li><a href="UploadFiles.html#multiple">multiple</a></li><li><a href="UploadFiles.html#noZip">noZip</a></li><li><a href="UploadFiles.html#parentId">parentId</a></li><li><a href="UploadFiles.html#required">required</a></li><li><a href="UploadFiles.html#selectFileLabel">selectFileLabel</a></li><li><a href="UploadFiles.html#size">size</a></li><li><a href="UploadFiles.html#uploadFileLabel">uploadFileLabel</a></li><li><a href="UploadFiles.html#videoFileSize">videoFileSize</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="UploadFiles.html#checkValidity">checkValidity</a></li><li><a href="UploadFiles.html#getErrorMessage">getErrorMessage</a></li><li><a href="UploadFiles.html#hasErrorMessage">hasErrorMessage</a></li><li><a href="UploadFiles.html#reportValidity">reportValidity</a></li><li><a href="UploadFiles.html#setCustomValidity">setCustomValidity</a></li></ul><div class="member-type">Events</div><ul class="inner"><li><a href="UploadFiles.html#event:upload">upload</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Mixins</h3><ul><li><a href="CustomInput.html">CustomInput</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="CustomInput_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="CustomInput.html#.controlClass">controlClass</a></li><li><a href="CustomInput.html#.helpMessage">helpMessage</a></li><li><a href="CustomInput.html#.horizontalLabel">horizontalLabel</a></li><li><a href="CustomInput.html#.required">required</a></li><li><a href="CustomInput.html#.value">value</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="CustomInput.html#.checkValidity">checkValidity</a></li><li><a href="CustomInput.html#.getErrorMessage">getErrorMessage</a></li><li><a href="CustomInput.html#.hasErrorMessage">hasErrorMessage</a></li><li><a href="CustomInput.html#.reportValidity">reportValidity</a></li><li><a href="CustomInput.html#.setCustomValidity">setCustomValidity</a></li><li><a href="CustomInput.html#.validate">validate</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Global</h3><ul><li class="hidden"><a href="global.html#Message">Message</a></li><li><a href="global.html#Severity">Severity</a></li></ul></div><h2>Testing</h2><div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="JestHtmlElement.html">JestHtmlElement</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="JestHtmlElement_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="JestHtmlElement.html#.apexMock">apexMock</a></li><li><a href="JestHtmlElement.html#.dispatch">dispatch</a></li><li><a href="JestHtmlElement.html#.isApexCalled">isApexCalled</a></li><li><a href="JestHtmlElement.html#.isEventDispatched">isEventDispatched</a></li><li><a href="JestHtmlElement.html#.isGenerated">isGenerated</a></li><li><a href="JestHtmlElement.html#.isNotGenerated">isNotGenerated</a></li><li><a href="JestHtmlElement.html#.listen">listen</a></li><li><a href="JestHtmlElement.html#.mock">mock</a></li><li><a href="JestHtmlElement.html#.query">query</a></li><li><a href="JestHtmlElement.html#.queryAll">queryAll</a></li><li><a href="JestHtmlElement.html#.queryUnique">queryUnique</a></li></ul></div></li><li><a href="SharedTestHelpers.html">SharedTestHelpers</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="SharedTestHelpers_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="SharedTestHelpers.html#.staticData">staticData</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="SharedTestHelpers.html#.apexMock">apexMock</a></li><li><a href="SharedTestHelpers.html#.createComponent">createComponent</a></li><li><a href="SharedTestHelpers.html#.flushPromises">flushPromises</a></li><li><a href="SharedTestHelpers.html#.getMessages">getMessages</a></li></ul></div></li><li><a href="SharedTestHelpers.Timer.html">Timer</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="SharedTestHelpers.Timer_sub"></div></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {api} from 'lwc';
import CustomInput from "c/customInput";
import CustomElement from "c/customElement";

import getFiles from '@salesforce/apex/UploadFilesController.getFiles';

import {loadScript} from 'lightning/platformResourceLoader';
import ZIP_JS from '@salesforce/resourceUrl/zipJs';

import labelZip_archive_is_not_supported from '@salesforce/label/c.Zip_archive_is_not_supported';
import labelUpload_File_Zip_Error from '@salesforce/label/c.Upload_File_Zip_Error';
import labelUpload_File_Multiple_Error from '@salesforce/label/c.Upload_File_Multiple_Error';
import labelFile_type_is_invalid from '@salesforce/label/c.File_type_is_invalid';
import labelAllowed_file_types from '@salesforce/label/c.Allowed_file_types';
import labelFile_size_is_too_big from '@salesforce/label/c.File_size_is_too_big';
import labelMaximum_file_size_is_0_MB from '@salesforce/label/c.Maximum_file_size_is_0_MB';

import {Strings, Arrays, Content, Files} from 'c/utils';

/**
 * @mixes CustomInput
 * @hideconstructor
 * @lwc
 */
class UploadFiles extends CustomInput(CustomElement) {
	/**
	 *
	 * @type String
	 */
	@api uploadFileLabel = ``;
	
	/**
	 * Salesforce ID of a parent record. If the attribute will be set,
	 * then the area to select files from the Salesforce record will be available.
	 * @type String
	 */
	@api parentId = ``;
	
	/**
	 *
	 * @type String
	 */
	@api selectFileLabel = ``;
	
	/**
	 *
	 * @type String
	 * @description A comma-separated list of file types, MIME types or extensions
	 * which are allowed to upload. Possible file types: audio, image, document and video.
	 * Extensions should start with '.' char.
	 */
	@api fileTypes;
	
	@api excludedFileTypes;
	
	/**
	 *
	 */
	@api baseFileSize;
	/**
	 *
	 */
	@api audioFileSize;
	/**
	 *
	 */
	@api documentFileSize;
	/**
	 *
	 */
	@api imageFileSize;
	/**
	 *
	 */
	@api videoFileSize;
	
	/**
	 *
	 * @type Boolean
	 * @default false
	 */
	@api multiple = false;
	
	/**
	 *
	 * @type Boolean
	 * @default false
	 */
	@api noZip = false;
	
	/**
	 * Content type of the files to be passed to {@link UploadFiles#upload} event.
	 * Converted content is sent to listeners of the {@link UploadFiles#upload} event
	 * via custom `.content` field of the
	 * [File]{@link https://developer.mozilla.org/en-US/docs/Web/API/File}.
	 * @type String
	 * @summary Possible values are `null` or `'text'` or `'base64'`.
	 * @default null
	 */
	@api contentType = ``;
	
	/**
	 * Sets the height and width of the drag&amp;drop area.
	 * @type String
	 * @summary Possible values are `standard` or `compact`.
	 * @default null
	 */
	@api size = `standard`;
	
	/**
	 *
	 * @type Boolean
	 * @default false
	 */
	@api required = false;
	
	/**
	 *
	 * @type String
	 */
	@api helpText = ``;
	
	@api showSelectedFiles = false;
	
	fileNameToDisplay;
	
	__dragCounter = 0;
	
	value = null;
	
	dropZoneStyle = ``;
	
	recordFiles = [];
	
	async connectedCallback() {
		try {
			this.dropZoneStyle = this.size === `standard`
				? `padding: 45px 0;` : ``;
			
			await Promise.all([
				loadScript(this, ZIP_JS + '/zip.js'),
				loadScript(this, ZIP_JS + '/deflate.js'),
				loadScript(this, ZIP_JS + '/inflate.js'),
			]);
			
			zip.useWebWorkers = false;
		} catch (e) {
			this.addError(e);
		}
	}
	
	handleDragEnter(event) {
		event.preventDefault();
		
		this.setDropZoneStyle(true);
	}
	
	handleDragLeave(event) {
		event.preventDefault();
		
		this.setDropZoneStyle(false);
	}
	
	handleDragOver(event) {
		event.preventDefault();
	}
	
	setDropZoneStyle(isEnter) {
		let backgroundColor = isEnter ? 'lightblue' : 'white';
		
		let incDec = isEnter ? 1 : -1;
		
		this.__dragCounter += incDec;
		
		if (isEnter || (!isEnter &amp;&amp; this.__dragCounter === 0)) {
			let dropZone = this.template.querySelector('.drop-zone');
			dropZone.style.background = backgroundColor;
		}
	}
	
	async handleFileChanged(event) {
		/**
		 * @event UploadFiles#upload
		 * @property {object} detail
		 * @property {File[]} detail.files Contains a list of the uploaded [Files]{@link https://developer.mozilla.org/en-US/docs/Web/API/File}.
		 * @property {Promise[]} detail.asyncHandlers An empty list of Promises. If a listener of the event has some asynchronous process then the listener code body must be wrapped with a Promise and pushed to the {@link asyncHandlers} list. If the Promise's resolve function will be called with `true` value of the parameter then it will be considered as success. Otherwise, the event will be canceled. By canceled event it means the file will not be considered as uploaded and the file name will not be shown on the component's UI.
		 * #### Example
		 * ```javascript
handleFilesUpload(event) {
	event.detail.asyncHandlers.push(new Promise(resolve => {
		setTimeout(() => {
			// Approves the upload if the uploaded file's name is `valid.txt`.
			// Otherwise, cancels the event.
			resolve(event.detail.files[0].name === `valid.txt`);
		}, 1000);
	}));
}
		 * ```
		 */
		
		await this.processFiles(event.detail.files, `upload`);
	}
	
	async handleDrop(event) {
		event.preventDefault();
		this.setDropZoneStyle(false);
		
		await this.processFiles(event.dataTransfer.files, `upload`);
	}
	
	async processFiles(files, eventName) {
		this.loading = true;
		
		this.value = null;
		
		files = Array.from(files);
		if (files.length === 0) {
			return;
		}
		
		let zipFound = false;
		for (const file of files) {
			if (this.isZip(file)) {
				zipFound = true;
				break;
			}
		}
		
		this.__errors = [];
		if (zipFound) {
			if (this.noZip) {
				this.__errors.push(labelZip_archive_is_not_supported);
			}
			
			if (files.length > 1) {
				this.__errors.push(labelUpload_File_Zip_Error);
			} else {
				files = await this.extractFromZip(files[0]);
			}
		}
		
		if (!this.multiple &amp;&amp; files.length > 1) {
			this.__errors.push(labelUpload_File_Multiple_Error);
		}
		
		const excludedFileTypes = this.fromFileTypesToExtensions(this.excludedFileTypes);
		const allowedFileExtensions = this.fromFileTypesToExtensions(this.fileTypes).filter(
			extension => !excludedFileTypes.includes(extension));
		
		for (const file of files) {
			let extension = this.getFileExtension(file.name);
			if (allowedFileExtensions &amp;&amp; !allowedFileExtensions.includes(extension)) {
				this.__errors.push(
					`${file.name}: ` + labelFile_type_is_invalid + ` ` +
					labelAllowed_file_types + `: ${allowedFileExtensions.join(', ')}`);
			}
		}
		
		for (const file of files) {
			const fileType = Files.getMediaTypeByExtension(this.getFileExtension(file.name));
			
			let fileSize;
			if (fileType) {
				fileSize = this[`${fileType}FileSize`];
			}
			
			if (!fileSize) {
				fileSize = this.baseFileSize;
			}
			
			if (fileSize &amp;&amp; file.size > fileSize * 1024 * 1024) {
				this.__errors.push(
					`${file.name}: ` + labelFile_size_is_too_big + ` ` +
					Strings.format(labelMaximum_file_size_is_0_MB, fileSize));
			}
		}
		
		this.setCustomValidity(``);
		
		this.value = files;
		
		this.fileNameToDisplay = ``;
		
		if (this.reportValidity()) {
			if (this.contentType) {
				for (const file of files) {
					file.content = await this.getContent(file);
				}
			}
			
			for (const file of files) {
				file.mediaType = Files.getMediaTypeByExtension(this.getFileExtension(file.name));
			}
			
			let canceled = await this.dispatchAsync(eventName, {
				files: files
			});
			if (!canceled) {
				if (this.showSelectedFiles) {
					this.fileNameToDisplay = files.map((file) => {
						return file.name;
					}).join(', ');
				}
			}
		}
		
		this.loading = false;
	}
	
	fromFileTypesToExtensions(fileTypes) {
		return fileTypes
			? Arrays.unique(
				fileTypes.split(`,`).map(type => type.trim()).reduce((result, type) => {
					if (type.includes(`/`)) {
						return result.concat(Files.getExtensionsByMimeType(type));
					} else if (type.startsWith(`.`)) {
						result.push(type.replace(/^\./, ``));
						return result;
					} else {
						return result.concat(Files.getExtensionsByMediaType(type));
					}
				}, []))
			: null;
	}
	
	validate() {
		let parentMessage = super.validate();
		if (parentMessage) {
			return parentMessage;
		}
		
		return this.__errors &amp;&amp; this.__errors.length > 0 ? this.__errors[0] : ``;
	}
	
	isZip(file) {
		return this.getFileExtension(file.name) === 'zip';
	}
	
	getFileExtension(fileName) {
		return fileName.substring((fileName.lastIndexOf('.') + 1));
	}
	
	extractFromZip(zipFile) {
		return new Promise((resolve) => {
			// use a BlobReader to read the zip from a Blob object
			zip.createReader(new zip.BlobReader(zipFile), reader => {
				// get all entries from the zip
				reader.getEntries(async entries => {
					let files = [];
					
					for (let entry of entries) {
						if (!entry.directory) {
							files.push(await this.getFileBody(entry));
						}
					}
					
					reader.close();
					
					resolve(files);
				});
			}, (e) => {
				this.addError(e);
			});
		});
	}
	
	getFileBody(entry) {
		return new Promise(resolve => {
			entry.getData(new zip.BlobWriter(), (blob) => {
				blob.name = entry.filename.replace(/^.*[\\\/]/, '');
				resolve(blob);
			});
		});
	}
	
	async getContent(file) {
		if (this.contentType === `base64`) {
			return (await Content.blobToBase64(file));
		} else if (this.contentType === `text`) {
			return (await Content.blobToText(file));
		}
	}
	
	async handleSelectFileButtonClicked() {
		this.recordFiles = await this.apex(getFiles, {recordId: this.parentId});
		
		for (const recordFile of this.recordFiles) {
			recordFile.formattedDate =
				new Intl.DateTimeFormat().format(new Date(recordFile.version.CreatedDate));
		}
	}
	
	async handleFileButtonClicked(event) {
		const recordFile = this.recordFiles.find(
			recordFile => recordFile.version.Id === event.currentTarget.dataset.fileId);
		
		let fileName = recordFile.version.PathOnClient;
		
		const file = await Content.base64ToFile(recordFile.base64content, fileName,
			Files.getMimeTypeByExtension(this.getFileExtension(fileName))
			?? `application/octet-stream`);
		
		file.id = recordFile.version.Id;
		
		await this.processFiles([file], `select`);
	}
}

export default UploadFiles;
</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="https://targetrecruit.com/wp-content/uploads/2022/07/TargetRecruit_logo_purple.png" style="width: 80px; height: 13px">
    <div class="footer-text">2023</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
